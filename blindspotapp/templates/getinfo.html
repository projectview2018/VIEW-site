{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'blindspotapp/getinfo.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'blindspotapp/home.css' %}">
<html>
	<style>
		body{
			font-family: Roboto, sans-serif;
		}
	</style>
<head>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
{% include 'header.html' %}
<div class="container">
  <h2 style="text-align: center;">Vehicle Information</h2>
  {% if user_results %}
  <!--h3 id="user-message">Your vehicle has been added to the database.</h3-->
  <h4 style="text-align: center;" id="user-results">{{ user_results }}</h4>
  {% endif %}

  <div id="histogram" style="display:block;">
    {% autoescape off %}

    {% endautoescape %}
  </div>
	{% if id_num %}
	<div id = "image_display">

		<div id = "vruselection">
			<label id = "vrulabel" for ="vruselect">Vulnerable Road User:</label>
			<select id = "vruselect" class="form-control chosen" value = "1" min = "0" max = "6" onchange = "vru_changed()">

				<option id = "preschool" value = "0">Preschool Child</option>
				<option id = "elem" value = "1">Elementary School Child</option>
				<option id = "elembicycle" value = "2">Elementary School Child on Bicycle</option>
				<option value = "3">Adult in Wheelchair</option>
				<option value = "4">Adult on Bicycle</option>
				<option value = "5">Adult</option>
				<option value = "6">None</option>
			</select>
			<label>Images may take a few seconds to load upon choosing a VRU. Additionally, slow internet speeds may affect image generation.</label>
		</div>

		<div id = "images_grid">
			<div  class="grid-container-1" id = "generated_images_1">
				<div class="grid-item-1">Front Blindzone<br><img id = "only_image"></img></div>
			</div>
			<div  class="grid-container-2" id = "generated_images_2">
				<div class="grid-item-2">Front Blindzone<br><img id = "left"></img></div>
				<div class="grid-item-2">Panoramic Photo<br><img id = "righ"></img></div>
			</div>
			<div  class="grid-container-4" id = "generated_images_4">
				<div class="grid-item-4">Front Blindzone<br><img id = "topleft"></img></div>
				<div class="grid-item-4" id = "overhead_view"> {% include 'getinfo_images.html' %}
				</div>
				<div class="grid-item-4">Panoramic Photo<br><img id = "toprigh"></img></img></div>
				<div class="grid-item-4">Passenger Side Blindzone<br><img id = "botrigh" ></img></img></div>

			</div>


		</div>

	</div>
	{% endif %}


  <!--
  <br />

  <h2 id="airtable-title">Database of Vehicles</h2>
  <h5>Filter, group, sort, search, or download database to compare vehicles:</h5>
  <iframe class="airtable-embed"
    src="https://airtable.com/embed/shrpAOauHRKx8WebW?backgroundColor=orange&viewControls=on" frameborder="0"
    onmousewheel="" width="100%" height="533" style="background: transparent; border: 1px solid #ccc;"></iframe>
  <br>
  -->
</div>
<div class = "container">

    <h4>Figure Notes:</h4>
	<p>A vulnerable road user is considered invisible if a driver cannot see their head. The calculations use the heights to the shoulders of 5th percentile United States female vulnerable road users. By VRU, the heights to shoulders are: preschool child 28 inches, elementary school child 37 inches, elementary school child on bicycle 35 inches, wheelchair user 39 inches, adult on bicycle 47 inches, adult 49 inches. </p>
<br>
<br>
	<h4 style="font-style:italic;font-size:13px;color:#2B2D42">This document is funded by the Santos Family Foundation and disseminated under the
		sponsorship of the Department of Transportation in the interest of information exchange. The United States
		Government assumes no liability for the contents or use thereof. The United States Government does not
		endorse products, manufacturers, or state or local policies or laws unless specifically indicated. Trade or
		manufacturersâ€™ names may appear herein solely because they are considered essential to the objective of this
		document. Site contents represent the best technical judgement of U.S. DOT Volpe Center staff based on their
		independent and objective technical analysis and expertise, and are not to be misconstrued as statements of
		U.S. DOT policy or guidance.
	</h4>
</div>




</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

<script type = "text/javascript">
	//var CLOUDINARY_URL =  'https://api.cloudinary.com/v1_1/dkrq49vzq/upload';
	var CLOUDINARY_URL =  'https://api.cloudinary.com/v1_1/usdot/upload';
//  var CLOUDINARY_UPLOAD_PRESET = 'ifmh0adn';
	var CLOUDINARY_UPLOAD_PRESET = 'elzascqq'; // unsigned upload preset name (more info here: https://make.cm/blog/make-a-photo-booth)
	window.onresize = edit_image_dimensions
	var panor_img = '{{panor_img}}';
	var front_img = '{{front_img}}';
	var side_img = '{{side_img}}';
	var done_generating = true;
	var grid_mode = 0;
	var two_column_width = 2.2;
	// this is so that the website will not try to generate images that will probably return a 503 error
	var low_vis =  parseInt("{{ percen }}" ) < 60;
	//keep track of all the generated overhead images for time efficiency
	var default_vru = 1;
	if (low_vis){
		default_vru = 5;
		var overhead_images = ["NA", "NA","NA","NA","NA",'{{top_img}}', "NA"];
		var front_images = ["NA", "NA","NA","NA","NA",'{{front_img}}', "NA"];
		var side_images = ["NA", "NA","NA","NA","NA",'{{side_img}}', "NA"];
	} else {
		var overhead_images = ["NA", '{{top_img}}',"NA","NA","NA","NA", "NA"];
		var front_images = ["NA", '{{front_img}}',"NA","NA","NA","NA", "NA"];
		var side_images = ["NA", '{{side_img}}',"NA","NA","NA","NA", "NA"];
	}


	// the overhead image that is currently waited for
	var waiting_to_disp = 1;
	// statuses: 0 means not started / done, 1 is in progress
	var started_generating = [ false, false, false, false, false ,false, false];

	//hide all of the grid stuff in case it doesn't load

	if (document.getElementById('image_display') !== null){
		document.getElementById('image_display').style.display = "None";
		document.getElementById('generated_images_1').style.display = "None";
		document.getElementById('generated_images_2').style.display = "None";
		document.getElementById('generated_images_4').style.display = "None";
		document.getElementById('vruselect').disabled = true;
	}

	//for really low visibility vehicles, we are not even going to try

	if ( low_vis ) {
		document.getElementById('preschool').disabled = true;
		document.getElementById('elem').disabled = true;
		document.getElementById('elembicycle').disabled = true;
		document.getElementById('vruselect').value=5;
	} else if ( "{{id_num}}" != "" ) {
		document.getElementById('vruselect').value=1;
	}

	//if there is an id num, attempt to display its images
	if ( "{{id_num}}" != "" ){
		//if the top image has not been generated (first page load from addvehicle, display all by the overhead, and then display it later

		if ('{{top_img}}' == "NA/q_auto:eco") {
			document.getElementById('vruselect').disabled = false;
			console.log("top_img = NA/q_auto:eco")
//			top_img = generate_overhead(default_vru);
//			display_images('{{panor_img}}', '{{front_img}}', '{{side_img}}', '{{top_img}}');
			display_images('{{panor_img}}', '{{front_img}}', '{{side_img}}', "NA");
			top_img = generate_overhead(default_vru);

			//upload_images( '{{front_img}}', '{{side_img}}');
		} else {
			//if the top has been generated, then just display like normal
			document.getElementById('vruselect').disabled = false;
			display_images('{{panor_img}}', '{{front_img}}', '{{side_img}}', '{{top_img}}');
			//upload_images( '{{front_img}}', '{{side_img}}', '{{top_img}}');
			overhead_images[default_vru] = '{{top_img}}';
			//generate all of the overhead stuff needed
			if ( low_vis) {
				generate_all_overhead('{{id_num}}', 3);
			} else {
				console.log("low_vis")
				generate_all_overhead('{{id_num}}', 0);
			}

		}

	}

	//main purpose is to check if the image is a "valid" image string
	function upload_images(front, side){
		var img_strings = [ front, side, top];
		var fields = ['Front', 'Side', 'Overhead'];
		for (var i = 0; i < 2; i ++ ){
			if (img_strings[i] !== undefined && img_strings[i] !== null) {
				if (!img_strings[i].startsWith("http") && img_strings[i] != ""){
					upload_image_ca(img_strings[i], fields[i] );
				}
			}

		}
	}

	//upload the images to cloudinary
	function upload_image_ca(string, field){
		image = new Image()
		image.src = 'data:image/jpeg;base64,' + string;

		var formData = new FormData();
		formData.append('file', image.src);
		formData.append('folder', 'generated-images');
		formData.append('public_id', "{{id_num}}" + "-" + field);
		formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

		axios({
			url: CLOUDINARY_URL,
			method: 'POST',
			headers: {
			  'Content-Type': 'application/x-www-form-urlencoded'
			},
			data: formData
		}).then(function(res) {
			//console.log(res);
			new_url = res["data"]["secure_url"];
			upload_image_at(new_url, field);
			console.log("uploaded image");
		}).catch(function(err) {
			console.log("failed to upload image");
			console.log(err);
		});
	}

	//upload the image to airtable to reduce airtable size
	function upload_image_at(image_url, field){
		let request = new XMLHttpRequest();
		let python_url = "/api/v1/uploadimages/";
		request.responseType = "json";
		var headers = { 'content-type': 'application/json' };
		request.onload = function () {
			let response = this.response;
			console.log("successful upload");
		}

		request.open("POST", python_url);
		request.send(body = JSON.stringify({ 'id_num': "{{id_num}}", "url" :image_url, "field": field}));
	}

	//main display images thing
	function display_images(panor, front, side, top){
		front_img = front;
		side_img = side;
		/*
		console.log(panor);
		console.log(front);
		console.log(side);
		console.log(top);
		*/
		//again, hide everything just in case
		console.log("display images");
		document.getElementById('image_display').style.display = "None";
		document.getElementById('generated_images_1').style.display = "None";
		document.getElementById('generated_images_2').style.display = "None";
		document.getElementById('generated_images_4').style.display = "None";
		base_width = document.getElementById("histogram").offsetWidth
		if (panor == "" && front == "" && side == "" && top ==""){
			//case 1: no images - do nothing
			console.log("case 1");

			//do nothing
		} else if (front != "" && side != "" && top !=""){
			document.getElementById('image_display').style.display = "";
			document.getElementById('generated_images_4').style.display = "";
			console.log("all four pictures case ")
			//console.log(panor, front, side, top)
			var topleft = document.getElementById('topleft');
			display_image(front, topleft);
			topleft.width = base_width / two_column_width;
			topleft.alt = "Visualization showing the amount of VRUs in front blindzone";
			topleft.title = "Visualization showing the amount of VRUs in front blindzone";

			var toprigh = document.getElementById('toprigh');
			//network errors can cause the panoramic image to not be uploaded, but all the other images can be generated via non image means
			if (panor != ""){
				display_image(panor,toprigh);
				toprigh.width = base_width / two_column_width;
			}
			toprigh.alt = "User-uploaded panoramic image of car vehicle";
			toprigh.title = "User-uploaded panoramic image of car vehicle";

			console.log("top: ")
			console.log(top)
			console.log(top.substring(0,2))
			if (top.substring(0,2) !== "NA"){
				var vru_index = document.getElementById('vruselect').value;
				if (vru_index < 10){

					img = document.getElementById('botleft');
					display_image(top,img);
					img.width =  base_width / (two_column_width * 1.85);
					img.style.display='';

					var botleft = document.getElementById('botleft');
					botleft.alt = "Visualization showing an overhead of the vehicle's blind zones and the total number of VRUs in it";
					botleft.title = "Visualization showing an overhead of the vehicle's blind zones and the total number of VRUs in it";

				} else {
					var botleft = document.getElementById('botleft');
					console.log("load plotly div")
					var overhead_view = document.getElementById('overhead_view');

					botleft.replaceWith(top);
				}
			} else {
				console.log("found it");
			//	document.getElementById('botleft').src = "#";
				var botleft = document.getElementById('botleft');
				console.log("load plotly div")
				var overhead_view = document.getElementById('overhead_view');

				botleft.replaceWith(top);
			}

			var botrigh = document.getElementById('botrigh');
			display_image(side,botrigh);
			botrigh.width =  base_width / two_column_width;
			botrigh.alt = "Visualization showing the amount of VRUs in side blindzone";
			botrigh.title = "Visualization showing the amount of VRUs in side blindzone";
			grid_mode = 4;

		}
		else if (panor != "" && front != ""){
			document.getElementById('image_display').style.display = "";
			document.getElementById('generated_images_2').style.display = "";
			//case 3: front view, panoramic
			console.log("front and panor pictures case ")
			//console.log(panor, front, side, top)
			var left = document.getElementById('left');
			display_image(front, left);
			left.width = base_width/ two_column_width;
			left.alt = "Visualization showing the amount of VRUs in front blindzone";
			left.title = "Visualization showing the amount of VRUs in front blindzone";

			var toprigh = document.getElementById('righ');
			display_image(panor,righ);
			righ.width = base_width / two_column_width;
			righ.alt = "User-uploaded panoramic image of car vehicle";
			righ.title = "User-uploaded panoramic image of car vehicle";
			grid_mode = 2;
		}
		else if ( front != ""){
			document.getElementById('image_display').style.display = "";
			document.getElementById('generated_images_1').style.display = "";
			//case 4: front view
			console.log("front case ")
			//console.log(panor, front, side, top)
			var only_image = document.getElementById('only_image');
			display_image(front, only_image);
			only_image.width = base_width / 1.5;
			only_image.alt = "Visualization showing the amount of VRUs in front blindzone";
			only_image.title = "Visualization showing the amount of VRUs in front blindzone";
			grid_mode = 1;

		} else {
			//this shouldn't happen
			console.log("else case");
		}

	}

	//assign the image_string as the source of the element - its own function because of the else statement
	function display_image( image_string, element) {
		if (image_string !== undefined && image_string !== null){
			console.log(image_string.substring(0, 10));
			if (image_string.startsWith("http")){
				element.src = image_string;
			} else {
				element.src = "data:image/jpeg;base64," + image_string
			}
		}


	}

	//done so that stuff shows up correctly when the window is zoomed in / out / resized
	function edit_image_dimensions(){
		//the histogram, which is guaranteed to show up and be resized properly on zooms, is the base width that we will use.
		base_width = document.getElementById("histogram").offsetWidth
		if (grid_mode == 4) {
			var topleft = document.getElementById('topleft');
			topleft.width = base_width / two_column_width;

			var botleft = document.getElementById('botleft');
			botleft.width = base_width / (two_column_width * 1.85);

			var toprigh = document.getElementById('toprigh');
			toprigh.width =  base_width / two_column_width;

			var botrigh = document.getElementById('botrigh');
			botrigh.width =  base_width / two_column_width;
		} else if (grid_mode == 2) {
			var left = document.getElementById('left');
			left.width = base_width / two_column_width;
			var righ = document.getElementById('righ');
			righ.width =  base_width / two_column_width;
		}else if (grid_mode == 1) {
			var only_image = document.getElementById('only_image');
			only_image.width = base_width / 1.5;
		}

	}

	//generate all the overhead images necessary
	/* perhaps a faster way to do this would be to first generate the "none" case and save the figure somehow (base 64 encoded string? would be a bit big).
	then, for each overhead image, just add in the vrus. this would save time as the figure is not re-generated every time. however, you would have to sacrifice some space, which is done already  */
	function generate_all_overhead(id_num, i){
		//if it has not started generating or has not been generated already (like through vru changes), generate it. else, do nothing
		if ( started_generating[i] == false && overhead_images[i] == "NA"){
			console.log("started generating " + i);
			started_generating[i] = true;
			let request = new XMLHttpRequest();

			let url = "/api/v1/getspecificimage/";
			request.responseType = "json";
			var headers = { 'content-type': 'application/json' };
			console.log("starting getspecificimage")
			request.onload = function(){
				let response = this.response;
				console.log("response started")
				if (response !== null) {
					console.log()

					top_string = response['data'];
					console.log(top_string);
					//vru was returned when all images were generated at once.
					vru = response['vru'];
					console.log("got overhead string index " + vru);
					if (vru == -1) {vru = 6;}
					started_generating[vru] = false;
					overhead_images[vru] = top_string;

					if (waiting_to_disp == vru ){
						//if we were waiting on something (like through vru changes, display to the middle)
						console.log("was waiting on " + vru + ": load to middle");
						waiting_to_disp = -2;
						done_generating = true;
						display_images( panor_img, front_img, side_img, top_string);
						document.getElementById('vruselect').disabled = false;
					}

				}  else{
					//if any of the things turn back null, just set all the things as stated generating to false
					//what happens on the test website is that once something returns null, everything else will also return null, so might as well
					//comment to tru
					if ( i == 0) {
						document.getElementById('preschool').disabled = true;
					}

					started_generating[i] = false
					if ( i == waiting_to_disp) {
						document.getElementById('vruselect').disabled = false;
						done_generating = true;
					}


				}
				generate_all_overhead(id_num, i + 1)
			}
			request.open("POST", url);
			//deal with None case
			if (i < 6){
				request.send(body = JSON.stringify( {"json_string": '{{id_num}}', "index" : 3, 'mode':1, 'vru': i}));
			} else {
				request.send(body = JSON.stringify( {"json_string": '{{id_num}}', "index" : 3, 'mode':1, 'vru': -1}));
			}


		} else if ( i == default_vru ){
			generate_all_overhead(id_num, i + 1)
		} else if (i <= 5) {
			generate_all_overhead(id_num, i + 1)
		}

	}
	//generate the overhead image on initial page load from addvehicles
	function generate_overhead(vru){
		let request = new XMLHttpRequest();
		let url = "/api/v1/getspecificimage/";
		request.responseType = "json";
		var headers = { 'content-type': 'application/json' };
		console.log("starting generate_overhead")

		started_generating[vru] = true;

		request.onload = function(){
			let response = this.response;
			if (response !== null){
				top_string = response['data'];
				//console.log(top_string);
				console.log(top_string.length );
				if (top_string != ""){
					console.log(top_string.substring(0, 10) );
					upload_image_ca(top_string, "Overhead");
					overhead_images[default_vru] = top_string;

					display_images('{{panor_img}}', '{{front_img}}', '{{side_img}}', top_string);
				}
				console.log("got overhead string");

				started_generating[vru] = false;

				document.getElementById('vruselect').disabled = false;
				//wait until the page properly loads until generating the rest of the images
				if ( low_vis) {
					document.getElementById('preschool').disabled = true;
					document.getElementById('elem').disabled = true;
					document.getElementById('elembicycle').disabled = true;
					document.getElementById('vruselect').value=5;
					generate_all_overhead('{{id_num}}', 3);

				} else {
					generate_all_overhead('{{id_num}}', 0);
				}
			} else if (vru == 1) {
				console.log("elem school failed - now mark as low vis and try again");
				low_vis = true;
				default_vru = 5;
				generate_overhead(5);


			} else {
				console.log("failed as adult, oh well, generate the others");
				started_generating[vru] = false;

				document.getElementById('vruselect').disabled = false;
				//wait until the page properly loads until generating the rest of the images
				if ( low_vis) {
					generate_all_overhead('{{id_num}}', 3);
				} else {
					generate_all_overhead('{{id_num}}', 0);
				}
			}


		}
		request.open("POST", url);
		request.send(body = JSON.stringify( {"json_string": '{{id_num}}', "index" : 3, 'mode':1, 'vru': vru, 'processed':false}));
	}
	//when vru changes
	function vru_changed(){
		var vru_index = document.getElementById('vruselect').value;
		document.getElementById('vruselect').disabled = true;
		//stops us from changing the vru before stuff is fully loaded
		if (done_generating){
			done_generating = false;
			var vru_i = vru_index;
			if (vru_i == 6) {vru_i = -1;}

			//console.log(vru_index);
			let request = new XMLHttpRequest();
			let url = "/api/v1/getvehicleimages_vruchanged/";
			request.responseType = "json";
			var headers = { 'content-type': 'application/json' };

			request.onload = function(){
				let response = this.response;
				console.log("got all new strings");
				if (this.response !== null){
					img_strings = response['data'];

					console.log(img_strings[0].substring(0, 10) );
					vru = response['vru'];

					//handles the None case
					if (vru == -1) {vru = 6;}


					front_img = img_strings[0];
					side_img = img_strings[1];

					//detects if onlyeasy was on or not
					if ( img_strings.length == 3){
						overhead_images[vru] = img_strings[2];
						started_generating[vru] = false;
						display_images(panor_img, img_strings[0], img_strings[1], img_strings[2] );
					} else {
						display_images(panor_img, img_strings[0], img_strings[1], overhead_images[vru] );
					}

					document.getElementById('vruselect').value = vru_index;
				}
				document.getElementById('vruselect').disabled = false;
				done_generating = true;
			}

			request.open("POST", url);
			request.timeout = 30000;
			console.log(vru_i);
			console.log("overhead_images[vru_index]");

			console.log(overhead_images[vru_index]);
			// if the overhead image has not been generated
			if ( overhead_images[vru_index] === "NA" ){
				if ( started_generating[vru_index] ) {
					//if the overhead image has started to be generated, only get the easy strings, and set the overhead image to display when it is done
					console.log("started generating - will wait");
					waiting_to_disp = vru_index;
					request.send(body = JSON.stringify( {"id_num": '{{id_num}}', "vru" : vru_i, 'onlyeasy' : 1, 'default':default_vru}));
				} else {
					//else, generate the image and mark it as being generated
					console.log("did not start generating, will do now");
					started_generating[vru_index] = true;
					request.send(body = JSON.stringify( {"id_num": '{{id_num}}', "vru" : vru_i, 'onlyeasy' : 0, 'default':default_vru}));
					waiting_to_disp = vru_index;
				}

			} else { // if the overhead image has been generated, only get the easy ones
				console.log("already generated");
				request.send(body = JSON.stringify( {"id_num": '{{id_num}}', "vru" : vru_i, 'onlyeasy' : 1, 'default':default_vru}));
				waiting_to_disp = -2;
			}

		}


	}

</script>

{% endblock %}